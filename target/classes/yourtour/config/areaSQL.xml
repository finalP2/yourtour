<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="area">
	
	<resultMap type="area" id="areaRes">
		 
		<!-- AREA 테이블 -->
		<result property="no" column="no" />
		<result property="name" column="name" />
		<result property="content" column="content" />
		<result property="address" column="address" />
		<result property="like1" column="like1" />
		<result property="way" column="way" />
		<result property="tel" column="tel" />
		<result property="hours" column="hours" />
		<result property="web" column="web" />
		<result property="city_no" column="city_no" />
		
	</resultMap>
	
	<resultMap type="areaImg" id="areaImgRes">
	
		<!-- AREA_IMG 테이블 -->
		<result property="no" column="no" />
		<result property="org_name" column="org_name" />
		<result property="sav_name" column="sav_name" />
		<result property="city_no" column="city_no" />
		
	</resultMap>
	
	<resultMap type="areaReview" id="areaReviewRes">
		
		<!-- AREA_REVIEW 테이블 -->
		<result property="no" column="no" />
		<result property="email" column="email" />
		<result property="area_no" column="area_no" />
		<result property="content" column="content" />
		<result property="writedate" column="writedate" />
		
	</resultMap>
	
	<!-- SELECT -->
	<!-- 여행지 검색 -->
	<select id="schAreaSearch" resultMap="areaRes" parameterType="HashMap">
		SELECT *
		FROM AREA 
		WHERE city_no = #{city_no} AND name LIKE #{searchKeyword}
		ORDER BY no ASC
	</select>
	
	<!-- 스케쥴 - 여행지 리스트  보기 -->
	<select id="schAreaList" resultMap="areaRes" parameterType="Integer" >
		SELECT *
		FROM AREA
    	where city_no = #{city_no}
		ORDER BY no ASC
	</select>
	
	<!-- 스케쥴 - 마커 찍을 장소 리스트 -->
	<select id="markerAreaList" resultMap="areaRes" parameterType="HashMap">
		SELECT * 
		FROM AREA JOIN AREA_IMG on AREA_IMG.NO = AREA.NO
		WHERE city_no = #{city_no} AND NOT EXISTS (SELECT * 
                             							   		 FROM SCH_DETAIL 
             	                    		 				     WHERE SCH_DETAIL.AREA_NO = AREA.NO AND NO = #{no} AND SCH_NO = ${sch_no})
	</select>
	
	<!-- 스케쥴 - 지역 번호로 여행지 리스트 불러오기 -->
	<select id="cityAreaList" resultMap="areaRes" parameterType="Integer">
		SELECT *
		FROM AREA INNER JOIN AREA_IMG
		USING(NO)
		WHERE CITY_NO = #{city_no}
	</select>
	
	<!-- 여행지 리스트  보기 -->	
	<select id="areaList" resultMap="areaRes" parameterType="HashMap" >
		SELECT *
		FROM AREA INNER JOIN AREA_IMG
		USING(NO)
		WHERE CITY_NO = #{city_no}
		ORDER BY NAME
	</select>
	
	<!-- 여행지 리스트 - 검색 -->
	<select id="areaSearch" resultMap="areaRes" parameterType="HashMap">
		SELECT *
		FROM AREA INNER JOIN AREA_IMG
		USING(NO)
		WHERE CITY_NO = #{city_no} AND (NAME LIKE #{searchKeyword} OR CONTENT LIKE #{searchKeyword})
		ORDER BY NAME
	</select>
	
	<!-- 메인에서 인기 여행지 리스트 LIKE 순으로 불러오기 -->
	<select id="areaLikeList" resultMap="areaRes">
		SELECT *
		FROM AREA INNER JOIN AREA_IMG
		USING(NO)
		WHERE LIKE1 = #{like1}
		ORDER BY LIKE1 DESC
	</select>

	<!-- 여행지 상세보기 -->
	<select id="areaDetail" resultMap="areaRes" parameterType="Integer">
		SELECT *
		FROM AREA
		WHERE NO = #{no}
	</select>
	
	<!-- 여행지 상세보기 할때 이미지 리스트 불러오기 -->
	<select id="areaImgList" resultMap="areaImgRes" parameterType="Integer">
		SELECT *
		FROM AREA_IMG
		WHERE NO = #{no}
	</select>
	
	<!-- 여행지 상세보기 할때 이미지 갤러리 메인 이미지 불러오기 -->
	<select id="main_img" resultType="String" parameterType="Integer">
		SELECT SAV_NAME
		FROM AREA_IMG
		WHERE NO = #{no} AND A_IMG_INDEX = 1
	</select>
	
	<!-- 여행지 상세보기 할때 리뷰 리스트 불러오기 -->
	<select id="areaReviewList" resultMap="areaReviewRes" parameterType="Integer">
		SELECT * 
		FROM AREA_REV
		WHERE NO = #{no}
		ORDER BY WRITEDATE DESC
	</select>
	
	<!-- 여행지 수정할때 이미지 원본이름 리스트 구하기 -->
	<select id="imgList" resultMap="areaRes" parameterType="Integer">
		SELECT ORG_NAME FROM AREA_IMG
		WHERE NO = #{no}
	</select>
	
	<!-- 여행지 수정하기 -->
	<update id="areaModify" parameterType="area">
		UPDATE AREA
		SET NAME=#{name},CONTENT=#{content},ADDRESS=#{address},WAY=#{way},TEL=#{tel},HOURS=#{hours},WEB=#{web}
		WHERE NO = #{no}
	</update>
	
	<!-- 수정할때 이미지첨부파일이 새로 입력되면 기존의 이미지첨부파일 삭제하기 -->
	<delete id="fileDelete" parameterType="Integer">
		DELETE FROM AREA_IMG
		WHERE NO = #{no}
	</delete>
	
	<!-- 여행지 리뷰 개수 구하기 -->
	<select id="revCount" resultType="Integer" parameterType="Integer">
		SELECT COUNT(*)
		FROM AREA_REV
		WHERE NO = #{no}
	</select>
	
	<!-- INSERT -->
	<!-- 여행지 글쓰기 -->
 	<insert id="areaWrite" parameterType="area" >
		INSERT INTO AREA(NO, NAME, CONTENT, ADDRESS, WAY, TEL, HOURS, WEB, CITY_NO)
		VALUES(AREA_NO_SEQ.NEXTVAL, #{name}, #{content}, #{address}, #{way}, #{tel}, #{hours}, #{web}, #{city_no})
	</insert>
	
	<!-- 파일 업로드 전에 no 값 보내주기 -->
	<select id="selectSeq" resultType="Integer">
		SELECT MAX(NO) FROM AREA
	</select>
	
	<!-- 파일 업로드 -->
	<insert id="fileupload" parameterType="HashMap">
		INSERT INTO AREA_IMG(NO, ORG_NAME, SAV_NAME, AREA_NO)
		VALUES(AREA_IMG_NO_SEQ.NEXTVAL, #{org_name}, #{sav_name}, #{area_no})
	</insert>
	
	<!-- 여행지 리뷰 쓰기 -->
	<insert id="areaReviewWrite" parameterType="areaReview">
		INSERT INTO AREA_REV(NO, EMAIL, AREA_NO, CONTENT, WRITEDATE)
		VALUES(AREA_REV_NO_SEQ.NEXTVAL, #{email}, #{area_no}, #{content}, sysdate)
	</insert>
	
	<!-- 여행지 리뷰 삭제하기 -->
	<delete id="areaReviewDelete" parameterType="Integer">
		DELETE FROM AREA_REV
		WHERE NO = #{no}
	</delete>
	
	<!-- UPDATE -->
	<!-- 여행지 글 삭제하기 -->
	<update id="areaDelete" parameterType="Integer">
		DELETE FROM AREA
		WHERE NO = #{no}
	</update>

	
</mapper>